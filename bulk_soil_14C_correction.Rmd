---
title: "Bulk soil 14C correction"
author: "Lydia Vaughn"
date: "13/08/2018"
output: html_document
---
 
Data: radiocarbon_incubation_Barrow_2014.csv is the set of radiocarbon data obtained from a soil incubation using soils sampled from the Barrow Environmental Observatory in September 2014.  naming.csv assigns a new name to each chamber according to the naming convention for this analysis. Dataset can be accessed at https://doi.org/10.5440/1418853.
```{r}
inc <- read.csv('data/radiocarbon_incubation_Barrow_2014.csv', skip = 7, header = F, sep = ',', stringsAsFactors = F)
headers = read.csv('data/radiocarbon_incubation_Barrow_2014.csv', skip = 5, header = F, nrows = 1, as.is = T)
naming <- read.csv('data/naming.csv', header = T, sep = ',', stringsAsFactors = F)
colnames(inc) <- headers
```

```{r}
library(tidyverse)
library(lubridate)
library(viridis)
```

change the names of the variables beginning with a number
```{r}
inc <- inc %>% rename("X13C" = "13C", "X14C" = "14C", "X14C_sigma" = "14C_sigma", "X14C_age" = "14C_age", "X14C_age_sigma" = "14C_age_sigma")
```

Add the correct chamber identifiers from the naming data frame
```{r}
inc <- inc %>% left_join(naming)
```

Associate each bulk soil 14C value with the correct CO2 production rate and CO2 14C value
```{r}
#subset data frame based on sample type
wide <- inc %>% filter(sample_type == "soil") %>% select("sample_name", "name", "layer_top", "layer_bot", "O2", "X14C", "X14C_sigma", "oc") %>% rename("C14_soil" = "X14C", "C14_soil_sigma" = "X14C_sigma") %>% left_join(inc %>% filter(sample_type == "CO2") %>% select("name", "layer_top", "layer_bot", "O2", "X14C", "X14C_sigma", "CO2_production") %>% rename("C14_CO2" = "X14C", "C14_CO2_sigma" = "X14C_sigma"))
```

Use mean CO2 production rate to calculate total carbon mineralized over 379 days (units = mg C per g soil) and the total carbon remaining in the bulk soil (units = mg C per g soil)
```{r}
wide <- wide %>% mutate(C_CO2 = CO2_production * 379, C_soil = oc * 10)
```

Calculate the FM and 14C value of the bulk soil prior to the incubation.  Do this as a mass-weighted average of (a) 14C of CO2 and CO2-carbon (mg C per g soil), and (b) 14C of remaining bulk soil C and remaining bulk soil C (mg C per g soil).
```{r}
wide <- wide %>% mutate(f_CO2 = C_CO2 / (C_CO2 + C_soil), f_soil = C_soil / (C_CO2 + C_soil), C14_total = f_CO2 * C14_CO2 + f_soil * C14_soil)
```

Propagate the Delta14C and FM standard deviations through the above calculation
```{r}
wide <- wide %>% mutate(C14_total_sigma = ((f_CO2 * C14_CO2 / (C_CO2 + C_soil) * C14_CO2_sigma)^2 + (f_soil * C14_soil / (C_CO2 + C_soil) * C14_soil_sigma)^2)^0.5)
```

Export the CO2 loss-corrected bulk soil radiocarbon values as a .csv file.  Use C14_soil_sigma for the analytical error for the loss-corrected bulk soil 14C values.  (The values calculated above are misleading.)
```{r}
export <- wide %>% select("sample_name", "name", "layer_top", "layer_bot", "O2", "oc", "C14_total", "C14_soil_sigma")

write.csv(export, 'data/loss_corrected_bulk_soil_radiocarbon.csv', quote=FALSE, row.names=FALSE)

```

Plot the bulk soil 14C values for each depth and polygon type
```{r}
plottheme <- theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  #theme(panel.border = element_rect(color="black", size=0.5, linetype="solid")) +
  theme(axis.text.y = element_text(color="black", size=9)) +
  theme(axis.text.x = element_text(color="black", size=11)) +
  theme(axis.title.y = element_text(size=11)) +
  theme(axis.title.x = element_blank()) 

toplot <- export %>% filter(O2 == "aerobic") %>% separate(sample_name, into = c("prof", "ancillary"), sep = "-") %>% separate(ancillary, into = c("depth", "year"), sep = " ") %>% separate(name, into = c("type", "position"), by = "-") %>% separate(type, into = c("type", "plot_number"), sep = "C")

summ <- toplot %>% filter(depth == "1") %>% group_by(type) %>% summarize(meanC14 = mean(C14_total, na.rm=T), sdC14 = sd(C14_total, na.rm=T), nC14 = length(C14_total[!is.na(C14_total)])) %>% mutate(seC14 = sdC14/nC14^0.5) %>% add_column(increment = "shallow") %>% full_join(toplot %>% filter(depth == "2") %>% group_by(type) %>% summarize(meanC14 = mean(C14_total, na.rm=T), sdC14 = sd(C14_total, na.rm=T), nC14 = length(C14_total)) %>% mutate(seC14 = sdC14/nC14^0.5) %>% add_column(increment = "deep"))

summ$seC14 <- ifelse(summ$nC14 > 2, summ$seC14, NA)

barbulk<-ggplot(summ, aes(x=increment, y=meanC14, fill=type)) +
  #geom_hline(yintercept=17.7, linetype="dashed", size=0.3) +
  geom_bar(stat="identity", width=0.7, position = position_dodge(0.7)) +
  geom_errorbar(aes(ymin=meanC14-seC14, ymax=meanC14+seC14), position=position_dodge(0.7), width=0.2, size=0.4) +
  ylab(expression(Delta^14*C ~ ("\u2030"))) +
  geom_hline(yintercept=0, size=0.3) +
  scale_fill_manual(breaks=c("H","F","L"), labels=c("High-centered","Flat-centered","Low-centered"), values = c("darkslateblue", "aquamarine4", "darkgoldenrod1" ), name = "Polygon type") +
  scale_x_discrete(breaks = c("shallow", "deep"), labels = c("Shallow", "Deep"))

print(barbulk + plottheme + theme(legend.position = c(.75, .25)))

ggsave("bulksoil14C.png", path="plots", width = 6,height = 5, units="in", dpi = 300)
```
